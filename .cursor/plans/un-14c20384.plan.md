<!-- 14c20384-7eab-4928-b208-13c7607814df 4004c0b2-d06c-4be7-b5ab-4990d12517a1 -->
# Kế hoạch triển khai Unified Trading Order API

### Mục tiêu

- Dựa trên spec trong `docs/api/api.md`, tạo **1 endpoint duy nhất** `POST /api/order` cho long/short + market/limit + TP/SL theo giá.
- Tận dụng tối đa logic sẵn có trong `api_server.py` và `perpsdex/*` (Lighter/Aster), hạn chế duplicate.

### Bước 1: Rà soát và chốt kiến trúc hiện tại

- Đọc `api_server.py` để hiểu các model (`MarketOrderRequest`, `LimitOrderRequest`, `ClosePositionRequest`) và flow `initialize_lighter_trader` / `initialize_aster_trader`.
- Đọc `perpsdex/lighter/api/main.py` và `perpsdex/aster/api/main.py` để tham khảo cách họ:
- Lấy giá thị trường (bid/ask),
- Đặt lệnh market/limit,
- Đặt TP/SL qua `RiskManager` / `Calculator`.
- Xác định rõ các hàm đã có thể tái sử dụng cho:
- place market order lighter/aster,
- place limit order lighter/aster (hiện một số phần còn TODO/501).

### Bước 2: Thiết kế model request thống nhất

- Trong `api_server.py`, định nghĩa 1 Pydantic model mới, ví dụ `UnifiedOrderRequest`, tương ứng 1:1 với spec trong `docs/api/api.md`:
- Trường bắt buộc: `exchange`, `symbol`, `side`, `order_type`, `size_usd`, `leverage`.
- Nếu `order_type = "limit"` → yêu cầu `limit_price`.
- Tuỳ chọn: `tp_price`, `sl_price`, `max_slippage_percent`, `client_order_id`, `tag`, `keys`.
- Áp dụng validation cơ bản trong model (ví dụ: `size_usd > 0`, `leverage >= 1`).

### Bước 3: Thiết kế hàm helper convert symbol & chọn sàn

- Thêm 1 helper trong `api_server.py`, ví dụ `normalize_symbol(exchange: str, base_symbol: str) -> dict`:
- Cho `lighter`: trả về `{ "symbol": base_symbol.upper(), "pair": f"{base_symbol.upper()}-USDT" }` và/hoặc `market_id` nếu cần.
- Cho `aster`: trả về `{ "symbol": f"{base_symbol.upper()}-USDT" }`.
- Đảm bảo nếu symbol không tồn tại trong config (ví dụ không tìm được `market_id`), trả HTTP 400.

### Bước 4: Triển khai logic validate TP/SL theo side

- Viết 1 helper, ví dụ `validate_tp_sl(side, entry_price, tp_price, sl_price)`:
- Với `side="long"`: check `sl_price < entry_price < tp_price` (cho các giá được gửi).
- Với `side="short"`: check `tp_price < entry_price < sl_price`.
- Nếu sai rule → raise `HTTPException(400, ...)` với message trùng logic mô tả trong `api.md`.

### Bước 5: Cài đặt endpoint POST /api/order

- Trong `api_server.py`, thêm route mới `@app.post("/api/order")` nhận `UnifiedOrderRequest`.
- Bên trong:
- Log request (exchange, symbol, side, order_type, size_usd, leverage, tp/sl).
- Lấy `keys` qua `get_keys_or_env` như các route cũ.
- Khởi tạo trader tương ứng: `initialize_lighter_trader` hoặc `initialize_aster_trader`.
- Gọi `normalize_symbol` để chuẩn hoá symbol/pair/market_id cho SDK.

### Bước 6: Xử lý order_type = market

- Nếu `order_type == "market"`:
- **Lighter**:
- Tận dụng `LighterTrader.place_order` hoặc flow trong `perpsdex/lighter/api/main.py` để:
- Lấy giá thị trường (ask cho long, bid cho short).
- Xử lý `max_slippage_percent` (nếu muốn, có thể làm sau bước 1).
- Đặt lệnh market với `side`, `size_usd`, `leverage`.
- Nếu có `tp_price`/`sl_price` → dùng `RiskManager`/`Calculator` tương tự endpoint long/short hiện có để tạo TP/SL.
- **Aster**:
- Sử dụng `OrderExecutor.place_market_order` trong `perpsdex/aster/core/order.py` giống `perpsdex/aster/api/main.py`.
- Đặt TP/SL nếu có, dùng `RiskManager` của Aster.
- Chuẩn hoá kết quả trả về theo format response đã mô tả trong `api.md` (success, order_id, entry_price, position_size, tp_price/sl_price…).

### Bước 7: Xử lý order_type = limit

- Nếu `order_type == "limit"`:
- **Lighter**:
- Kiểm tra SDK hiện có support limit như thế nào (từ `OrderExecutor.place_limit_order` hoặc tương đương nếu có).
- Nếu chưa đầy đủ, tạm thời:
- Hoặc trả HTTP 501 cho Lighter-limit,
- Hoặc implement tối thiểu nếu có đầy đủ primitive (tạo order với limit price, good-till-time-force).
- **Aster**:
- Sử dụng `OrderExecutor.place_limit_order` như trong `perpsdex/aster/api/main.py`.
- Đặt TP/SL dựa trên `limit_price` (như spec).
- Trả về response cùng format với market (order_type = "limit").

### Bước 8: Thu gọn hoặc deprecate các route cũ

- Xem xét 3 route hiện tại trong `api_server.py`:
- `POST /api/order/market`
- `POST /api/order/limit`
- `POST /api/order/close`
- Tuỳ nhu cầu:
- Ngắn hạn: giữ route cũ nhưng **document là deprecated** và khuyến nghị dùng `/api/order`.
- Dài hạn: refactor code của route cũ để gọi chung vào helper logic của `/api/order` (tránh duplicate), sau đó có thể xoá route cũ khi không còn client dùng.

### Bước 9: Cập nhật tài liệu & ví dụ

- Đảm bảo `docs/api/api.md` khớp 100% với behaviour thực tế:
- Nếu có khác biệt nhỏ (ví dụ: Lighter hiện chưa hỗ trợ limit-order), thêm ghi chú rõ.
- Thêm 1 đoạn QUICK START ngắn trong `docs/api/api.md` hoặc file riêng:
- Bước 1: chuẩn bị env.
- Bước 2: chạy server (python api_server.py hoặc uvicorn api_server:app …).
- Bước 3: ví dụ cURL 1 lệnh market long và 1 lệnh limit short.

### Bước 10: Kiểm tra & hardening

- Viết hoặc chạy lại các test thủ công qua Swagger UI:
- Case market long/short cho cả Lighter/Aster (có/không TP/SL).
- Case limit long/short (ít nhất cho Aster).
- Case invalid TP/SL (vi phạm rule) để chắc chắn trả lỗi 400 đúng.
- Kiểm tra error handling khi:
- Thiếu/invalid keys,
- Không đủ balance,
- Symbol không support.
- Sau khi ổn định, cân nhắc cleanup nhẹ trong `api_server.py` (bớt log thừa, gom helper chung).

### To-dos

- [ ] Rà soát `api_server.py` và các API Lighter/Aster hiện có trong `perpsdex/*` để hiểu flow đặt lệnh market/limit và TP/SL.
- [ ] Thiết kế và thêm Pydantic model `UnifiedOrderRequest` trong `api_server.py` theo spec `docs/api/api.md`.
- [ ] Tạo helper chuẩn hoá symbol theo sàn (base symbol → pair/market_id) và xử lý lỗi khi symbol không hỗ trợ.
- [ ] Thêm helper validate TP/SL theo side (long/short) và entry/limit price, trả HTTP 400 nếu sai rule.
- [ ] Thêm route `POST /api/order` dùng `UnifiedOrderRequest`, gọi đúng trader Lighter/Aster và symbol normalization.
- [ ] Trong endpoint mới, cài đặt flow cho `order_type=market` cho cả Lighter và Aster, bao gồm TP/SL nếu có.
- [ ] Trong endpoint mới, cài đặt flow cho `order_type=limit` (ít nhất cho Aster; với Lighter nếu support, nếu không trả 501).
- [ ] Quyết định việc giữ/deprecate/xoá các endpoint cũ `/api/order/market`, `/api/order/limit`, `/api/order/close` và refactor nếu cần.
- [ ] Đảm bảo `docs/api/api.md` mô tả đúng hành vi thực tế của `/api/order` và thêm QUICK START ngắn.
- [ ] Test thủ công qua Swagger/cURL cho các case chính, kiểm tra error handling và chỉnh lại message nếu cần.